#!/bin/bash
set -e

cd $(dirname $0)/..

echo "Start building ISO image"

HARVESTER_INSTALLER_VERSION=iso-upgrade-dev

git clone --branch ${HARVESTER_INSTALLER_VERSION} --single-branch --depth 1 https://github.com/gitlawr/harvester-installer.git ../harvester-installer

cd ../harvester-installer/scripts

#test
export HARVESTER_INSTALLER_OFFLINE_BUILD=1

./ci

cd ..
HARVESTER_DIR=../harvester

# Prepare files for the bundle image
cp -r manifests ${HARVESTER_DIR}/package
cp k3os/images/70-iso/charts/harvester-*.tgz ${HARVESTER_DIR}/package
TAG=f02075c-amd64
id=$(docker create rancher/k3os:harvester-${TAG})
docker cp $id:/k3os ${HARVESTER_DIR}/package
docker rm -v $id

mkdir -p ${HARVESTER_DIR}/dist/artifacts
cp dist/artifacts/* ${HARVESTER_DIR}/dist/artifacts

